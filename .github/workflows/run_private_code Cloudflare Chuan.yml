name: run-private-code

on:
  schedule:
    - cron: '0 2 * * *'   # 11:00 VN
    - cron: '0 4 * * *'   # 13:00 VN
    - cron: '0 10 * * *'   # 16:00 VN
    
  workflow_dispatch: {}

jobs:
  run-private:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: run-private-${{ github.ref }}
      cancel-in-progress: false

    env:
      # Secrets YouTube (đặt ở repo CÔNG KHAI)
      YT_CLIENT_ID:     ${{ secrets.YT_CLIENT_ID }}
      YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}

      # chọn thumb tiêu đề bắt đầu
      SEQ_BASE_RUN: "2"
      TITLE_START: "1"
      THUMB_START: "1"

      # công tắc chọn poll hoặc cloudflare
      IMG_PROVIDER: cloudflare
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_API_TOKEN:  ${{ secrets.CF_API_TOKEN }}
      CF_MODEL: "@cf/black-forest-labs/flux-1-schnell"
      CF_STEPS: "8"

    steps:
      - name: Checkout wrapper (repo PUBLIC)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Quyết định mode auth (không dùng secrets trực tiếp trong if)
      - name: Determine auth mode
        id: auth
        env:
          HAS_PAT: ${{ secrets.PRIVATE_REPO_TOKEN }}
          HAS_SSH: ${{ secrets.PRIVATE_SSH_KEY }}
        run: |
          if [ -n "$HAS_PAT" ]; then
            echo "mode=pat" >> "$GITHUB_OUTPUT"
          elif [ -n "$HAS_SSH" ]; then
            echo "mode=ssh" >> "$GITHUB_OUTPUT"
          else
            echo "mode=none" >> "$GITHUB_OUTPUT"
          fi

      # support chạy không truyền inputs
      - name: Resolve parameters (support schedule without inputs)
        id: params
        run: |
          repo="${{ inputs.private_repo }}"; [ -z "$repo" ] && repo="tquynhnhi333-collab/rieng-tu"; echo "repo=$repo" >> "$GITHUB_OUTPUT"
          ref="${{ inputs.private_ref }}";   [ -z "$ref" ] && ref="main";                   echo "ref=$ref" >> "$GITHUB_OUTPUT"
          wd="${{ inputs.workdir }}";        [ -z "$wd" ]  && wd=".";                       echo "workdir=$wd" >> "$GITHUB_OUTPUT"
          privacy="${{ inputs.youtube_privacy }}"; [ -z "$privacy" ] && privacy="public";   echo "privacy=$privacy" >> "$GITHUB_OUTPUT"

      - name: Export resolved privacy to env
        run: echo "YOUTUBE_PRIVACY=${{ steps.params.outputs.privacy }}" >> "$GITHUB_ENV"

      # Kéo code từ repo PRIVATE (PAT)
      - name: Checkout PRIVATE via PAT
        if: ${{ steps.auth.outputs.mode == 'pat' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.params.outputs.repo }}
          ref: ${{ steps.params.outputs.ref }}
          path: private-src
          fetch-depth: 1
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          persist-credentials: false

      # Kéo code từ repo PRIVATE (SSH)
      - name: Checkout PRIVATE via SSH Deploy Key
        if: ${{ steps.auth.outputs.mode == 'ssh' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.params.outputs.repo }}
          ref: ${{ steps.params.outputs.ref }}
          path: private-src
          fetch-depth: 1
          ssh-key: ${{ secrets.PRIVATE_SSH_KEY }}
          persist-credentials: false

      - name: Fail if no auth available
        if: ${{ steps.auth.outputs.mode == 'none' }}
        run: |
          echo "::error::Không checkout được repo private. Cần PRIVATE_REPO_TOKEN (PAT) hoặc PRIVATE_SSH_KEY (Deploy key)."
          exit 1

      - name: Verify PRIVATE checkout
        working-directory: private-src
        run: |
          pwd && ls -la
          echo "== 20 files in commit =="
          git ls-tree -r --name-only HEAD | head -n 20

      # Tự tìm thư mục chứa scripts/generate_thumbnails.py
      - name: Detect script path
        id: find_script
        run: |
          set -e
          BASE="private-src"
          DEFAULT="${{ steps.params.outputs.workdir }}"
          CAND=""
          if [ -n "$DEFAULT" ] && [ -f "$BASE/$DEFAULT/scripts/generate_thumbnails.py" ]; then
            CAND="$BASE/$DEFAULT"
          else
            CAND=$(cd "$BASE" && find . -type f -path "*/scripts/generate_thumbnails.py" -print -quit | sed 's|^\./||' | xargs -I{} dirname {})
            [ -n "$CAND" ] && CAND="$BASE/$CAND"
          fi
          if [ -z "$CAND" ]; then
            echo "::error::Không tìm thấy scripts/generate_thumbnails.py trong repo private."
            exit 1
          fi
          echo "dir=$CAND" >> "$GITHUB_OUTPUT"
          echo "[FOUND] $CAND"

      # Bắt buộc có secrets YT để upload thẳng
      - name: Require YT OAuth secrets
        shell: bash
        run: |
          miss=0
          for k in YT_CLIENT_ID YT_CLIENT_SECRET YT_REFRESH_TOKEN; do
            if [ -z "${!k}" ]; then
              echo "::error::Thiếu secret $k"
              miss=1
            fi
          done
          if [ "$miss" = "1" ]; then
            exit 1
          fi
          echo "[OK] YT secrets đầy đủ."

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (ffmpeg)
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('private-src/**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ===== FIX CHÍNH =====
      - name: Install Python libs
        working-directory: ${{ steps.find_script.outputs.dir }}
        run: |
          python -m pip install --upgrade pip

          # Giữ pkg_resources cho whisper build
          python -m pip install --force-reinstall "setuptools==69.5.1" "wheel==0.43.0" packaging
          python -c "import pkg_resources; print('pkg_resources OK')"

          # Cài deps từ requirements đã pin numpy/opencv
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          else
            echo "::warning::Không thấy requirements.txt trong $PWD, cài tối thiểu fallback."
            python -m pip install \
              Pillow==10.3.0 \
              opencv-python-headless==4.10.0.84 \
              numpy==1.26.4 \
              imageio-ffmpeg yt-dlp gdown \
              google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib \
              requests google-genai
          fi

          # Torch CPU + torchaudio
          python -m pip install "torch==2.3.1" "torchaudio==2.3.1" --index-url https://download.pytorch.org/whl/cpu

          # Re-pin lại backend build (tránh requirements kéo lệch)
          python -m pip install --force-reinstall "setuptools==69.5.1" "wheel==0.43.0"
          python -c "import pkg_resources; print('pkg_resources still OK')"

          # Cài whisper KHÔNG build isolation
          python -m pip install --no-build-isolation --no-cache-dir "openai-whisper==20231117"

          # Verify
          python -c "import whisper, torch, torchaudio, numpy, cv2, pkg_resources; print('ALL OK:', whisper.__version__, torch.__version__)"
          python -m pip check || true

      # Chạy code trong repo PRIVATE
      - name: Run pipeline in PRIVATE
        working-directory: ${{ steps.find_script.outputs.dir }}
        run: |
          set -e
          python -u scripts/generate_thumbnails.py

      # Commit & PUSH CSV về repo PRIVATE qua PAT
      - name: Commit & push state CSVs back to PRIVATE (PAT)
        if: ${{ steps.auth.outputs.mode == 'pat' }}
        working-directory: private-src
        env:
          PUSH_TOKEN_1: ${{ secrets.PRIVATE_REPO_PUSH_TOKEN }}
          PUSH_TOKEN_2: ${{ secrets.PRIVATE_REPO_TOKEN }}
          PRIVATE_REPO: ${{ steps.params.outputs.repo }}
          PRIVATE_REF: ${{ steps.params.outputs.ref }}
          DIR_FOUND: ${{ steps.find_script.outputs.dir }}
        run: |
          set -euo pipefail
          TOKEN="${PUSH_TOKEN_1:-$PUSH_TOKEN_2}"
          [ -z "$TOKEN" ] && { echo "::warning::Không có token có quyền ghi. Bỏ qua commit."; exit 0; }

          FILES=""
          for f in links_done.csv promptdalay.csv tieudedalay.csv; do
            [ -f "$f" ] && FILES="$FILES $f"
            [ -n "$DIR_FOUND" ] && [ -f "$DIR_FOUND/$f" ] && FILES="$FILES $DIR_FOUND/$f"
          done
          [ -z "$FILES" ] && { echo "[INFO] Không có CSV để commit."; exit 0; }

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${PRIVATE_REPO}.git"

          CURBR=$(git rev-parse --abbrev-ref HEAD || true)
          [ "$CURBR" = "HEAD" ] && git checkout -b ci-state-update

          git add -- $FILES
          git diff --cached --quiet && { echo "[INFO] Không có thay đổi."; exit 0; }
          git commit -m "ci(state): update promptdalay.csv, links_done.csv, tieudedalay.csv"

          # Giảm lỗi non-fast-forward khi có job khác vừa push
          git pull --rebase origin "${PRIVATE_REF}" || true

          # Retry push để vượt lỗi GitHub 5xx tạm thời
          for i in 1 2 3 4 5; do
            if git push origin HEAD:"${PRIVATE_REF}"; then
              echo "[OK] Push thành công."
              exit 0
            fi
            echo "::warning::Push fail lần $i. Retry sau $((i*5))s..."
            sleep $((i*5))
          done

          echo "::error::Push thất bại sau 5 lần retry."
          exit 1

      # Commit & PUSH CSV về repo PRIVATE qua SSH
      - name: Commit & push state CSVs back to PRIVATE (SSH)
        if: ${{ steps.auth.outputs.mode == 'ssh' }}
        working-directory: private-src
        env:
          PRIVATE_SSH_KEY: ${{ secrets.PRIVATE_SSH_KEY }}
          PRIVATE_REPO: ${{ steps.params.outputs.repo }}
          PRIVATE_REF: ${{ steps.params.outputs.ref }}
          DIR_FOUND: ${{ steps.find_script.outputs.dir }}
        run: |
          set -euo pipefail
          [ -z "$PRIVATE_SSH_KEY" ] && { echo "::warning::Thiếu PRIVATE_SSH_KEY. Bỏ qua commit."; exit 0; }

          install -m 700 -d ~/.ssh
          echo "$PRIVATE_SSH_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_deploy
          printf "Host github.com\n  StrictHostKeyChecking accept-new\n" >> ~/.ssh/config

          FILES=""
          for f in promptdalay.csv links_done.csv tieudedalay.csv; do
            [ -f "$f" ] && FILES="$FILES $f"
            [ -n "$DIR_FOUND" ] && [ -f "$DIR_FOUND/$f" ] && FILES="$FILES $DIR_FOUND/$f"
          done
          [ -z "$FILES" ] && { echo "[INFO] Không có CSV để commit."; exit 0; }

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "git@github.com:${PRIVATE_REPO}.git"

          CURBR=$(git rev-parse --abbrev-ref HEAD || true)
          [ "$CURBR" = "HEAD" ] && git checkout -b ci-state-update

          git add -- $FILES
          git diff --cached --quiet && { echo "[INFO] Không có thay đổi."; exit 0; }
          git commit -m "ci(state): update promptdalay.csv, links_done.csv, tieudedalay.csv"

          # Giảm lỗi non-fast-forward khi có job khác vừa push
          git pull --rebase origin "${PRIVATE_REF}" || true

          # Retry push để vượt lỗi GitHub 5xx tạm thời
          for i in 1 2 3 4 5; do
            if git push origin HEAD:"${PRIVATE_REF}"; then
              echo "[OK] Push thành công."
              exit 0
            fi
            echo "::warning::Push fail lần $i. Retry sau $((i*5))s..."
            sleep $((i*5))
          done

          echo "::error::Push thất bại sau 5 lần retry."
          exit 1
